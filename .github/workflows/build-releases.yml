name: æ„å»ºå¯æ‰§è¡Œæ–‡ä»¶

on:
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      create_release:
        description: 'æ˜¯å¦åˆ›å»º GitHub Release'
        required: false
        default: 'false'
        type: boolean
  
  # æ¨é€åˆ° main åˆ†æ”¯æ—¶è§¦å‘
  push:
    branches: [ master ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - 'static/screenshot/**'
  
  # Pull Request æ—¶è§¦å‘ï¼ˆä»…æ„å»ºï¼Œä¸å‘å¸ƒï¼‰
  pull_request:
    branches: [ master ]

jobs:
  build:
    name: æ„å»º ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: windows-latest
            platform: windows-x64
            executable: XHS-Downloader.exe
            archive_cmd: '7z a'
            archive_ext: '.zip'
          - os: macos-latest
            platform: macos-arm64
            executable: XHS-Downloader
            archive_cmd: 'tar -czf'
            archive_ext: '.tar.gz'
          - os: macos-13  # Intel macOS
            platform: macos-x64  
            executable: XHS-Downloader
            archive_cmd: 'tar -czf'
            archive_ext: '.tar.gz'

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½® Python 3.12
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
        cache: 'pip'

    - name: å®‰è£…é¡¹ç›®ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller>=6.0.0

    - name: æ„å»ºå¯æ‰§è¡Œæ–‡ä»¶
      run: |
        python build.py

    - name: éªŒè¯æ„å»ºç»“æœ
      shell: bash
      run: |
        if [ -f "dist/${{ matrix.executable }}" ]; then
          echo "âœ… æ„å»ºæˆåŠŸ: dist/${{ matrix.executable }}"
          ls -la dist/
          # è·å–æ–‡ä»¶å¤§å°
          if [[ "${{ matrix.os }}" == "windows-latest" ]]; then
            powershell -Command "Get-ChildItem dist/${{ matrix.executable }} | Select-Object Name,Length"
          else
            du -h dist/${{ matrix.executable }}
          fi
        else
          echo "âŒ æ„å»ºå¤±è´¥: æœªæ‰¾åˆ° dist/${{ matrix.executable }}"
          ls -la dist/ || echo "dist ç›®å½•ä¸å­˜åœ¨"
          exit 1
        fi

    - name: é‡å‘½åå¯æ‰§è¡Œæ–‡ä»¶
      shell: bash
      run: |
        cd dist
        if [[ "${{ matrix.platform }}" == "windows-x64" ]]; then
          mv "${{ matrix.executable }}" "XHS-Downloader-${{ matrix.platform }}.exe"
          FINAL_NAME="XHS-Downloader-${{ matrix.platform }}.exe"
        else
          mv "${{ matrix.executable }}" "XHS-Downloader-${{ matrix.platform }}"
          FINAL_NAME="XHS-Downloader-${{ matrix.platform }}"
        fi
        echo "FINAL_NAME=${FINAL_NAME}" >> $GITHUB_ENV

    - name: åˆ›å»ºå‹ç¼©åŒ… (Windows)
      if: matrix.os == 'windows-latest'
      run: |
        cd dist
        7z a "XHS-Downloader-${{ matrix.platform }}.zip" "XHS-Downloader-${{ matrix.platform }}.exe" "*info.txt"

    - name: åˆ›å»ºå‹ç¼©åŒ… (macOS)
      if: startsWith(matrix.os, 'macos')
      run: |
        cd dist
        tar -czf "XHS-Downloader-${{ matrix.platform }}.tar.gz" "XHS-Downloader-${{ matrix.platform }}" *info.txt

    - name: ç”Ÿæˆæ ¡éªŒæ–‡ä»¶
      shell: bash
      run: |
        cd dist
        if [[ "${{ matrix.platform }}" == "windows-x64" ]]; then
          ARCHIVE="XHS-Downloader-${{ matrix.platform }}.zip"
          powershell -Command "Get-FileHash '$ARCHIVE' -Algorithm SHA256 | Format-List" > "${ARCHIVE}.sha256"
        else
          ARCHIVE="XHS-Downloader-${{ matrix.platform }}.tar.gz"
          shasum -a 256 "$ARCHIVE" > "${ARCHIVE}.sha256"
        fi

    - name: ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: XHS-Downloader-${{ matrix.platform }}
        path: |
          dist/XHS-Downloader-${{ matrix.platform }}*
        retention-days: 30

  release:
    name: åˆ›å»º Release
    needs: build
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'workflow_dispatch' && github.event.inputs.create_release == 'true') ||
      (github.event_name == 'push' && github.ref == 'refs/heads/master')
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
      uses: actions/download-artifact@v4
      with:
        path: releases

    - name: å‡†å¤‡å‘å¸ƒæ–‡ä»¶
      run: |
        mkdir -p release_files
        find releases -name "*.zip" -o -name "*.tar.gz" -o -name "*.sha256" | while read file; do
          cp "$file" release_files/
        done
        ls -la release_files/

    - name: ç”Ÿæˆå‘å¸ƒæ ‡ç­¾
      id: tag
      run: |
        TAG="v$(date +'%Y.%m.%d')-$(echo $GITHUB_SHA | cut -c1-7)"
        echo "tag=$TAG" >> $GITHUB_OUTPUT
        echo "Generated tag: $TAG"

    - name: åˆ›å»º Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.tag.outputs.tag }}
        name: XHS-Downloader ${{ steps.tag.outputs.tag }}
        body: |
          ## ğŸš€ XHS-Downloader è‡ªåŠ¨æ„å»ºç‰ˆæœ¬
          
          **æ„å»ºæ—¶é—´**: $(date +'%Y-%m-%d %H:%M:%S UTC')
          **æäº¤**: ${{ github.sha }}
          
          ### ğŸ“¦ ä¸‹è½½è¯´æ˜
          
          | å¹³å° | æ–‡ä»¶ | ç³»ç»Ÿè¦æ±‚ |
          |------|------|----------|
          | Windows | `XHS-Downloader-windows-x64.zip` | Windows 10+ |
          | macOS (Apple Silicon) | `XHS-Downloader-macos-arm64.tar.gz` | macOS 11.0+ |
          | macOS (Intel) | `XHS-Downloader-macos-x64.tar.gz` | macOS 10.15+ |
          
          ### ğŸ” å®‰å…¨æ ¡éªŒ
          
          æ¯ä¸ªå‹ç¼©åŒ…éƒ½æä¾›äº† SHA256 æ ¡éªŒæ–‡ä»¶ï¼Œè¯·åœ¨ä½¿ç”¨å‰éªŒè¯æ–‡ä»¶å®Œæ•´æ€§ã€‚
          
          ### ğŸ“‹ ä½¿ç”¨æ–¹æ³•
          
          1. ä¸‹è½½å¯¹åº”å¹³å°çš„å‹ç¼©åŒ…
          2. è§£å‹ç¼©åˆ°ä»»æ„ç›®å½•
          3. è¿è¡Œå¯æ‰§è¡Œæ–‡ä»¶ï¼š
             - Windows: åŒå‡» `XHS-Downloader.exe`
             - macOS: ç»ˆç«¯è¿è¡Œ `./XHS-Downloader`
          
          ### âš ï¸ æ³¨æ„äº‹é¡¹
          
          - é¦–æ¬¡è¿è¡Œä¼šåœ¨å½“å‰ç›®å½•åˆ›å»ºé…ç½®æ–‡ä»¶
          - macOS ç”¨æˆ·å¯èƒ½éœ€è¦åœ¨"ç³»ç»Ÿåå¥½è®¾ç½® > å®‰å…¨æ€§ä¸éšç§"ä¸­å…è®¸è¿è¡Œ
          - éƒ¨åˆ†æ€æ¯’è½¯ä»¶å¯èƒ½è¯¯æŠ¥ï¼Œè¿™æ˜¯ PyInstaller çš„å¸¸è§é—®é¢˜
          
          ---
          
          **å®Œæ•´æ›´æ–°æ—¥å¿—**: [æŸ¥çœ‹æäº¤å†å²](https://github.com/${{ github.repository }}/compare/${{ github.event.before }}...${{ github.sha }})
        files: release_files/*
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}